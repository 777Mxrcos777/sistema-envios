<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Env√≠os ‚Äî Prototipo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 min-h-screen text-slate-100 flex items-center justify-center p-6">

  <div class="w-full max-w-3xl">
    <header class="mb-6 text-center">
      <h1 class="text-2xl font-bold">üì¶ Sistema de Env√≠os ‚Äî Prototipo Interactivo</h1>
      <p class="text-sm text-slate-400 mt-1">Flujo: Registro ‚Üí Validaci√≥n ‚Üí Clasificaci√≥n ‚Üí Transporte ‚Üí Entrega (con alertas y correcci√≥n)</p>
    </header>

    <!-- Barra de progreso -->
    <div id="progress" class="mb-6"></div>

    <!-- Contenedor principal -->
    <div id="app" class="bg-slate-800 rounded-2xl p-6 shadow-lg"></div>

    <!-- Panel de estad√≠sticas / morfog√©nesis -->
    <aside class="mt-6 bg-slate-700 rounded-lg p-4 text-sm text-slate-200">
      <h3 class="font-semibold">Estad√≠sticas del sistema</h3>
      <div id="stats" class="mt-2 space-y-1">
        <!-- Se llena por JS -->
      </div>
      <p id="morphoMsg" class="mt-3 text-xs text-slate-300"></p>
    </aside>
  </div>

<script>
/*
  Prototipo completo:
  - Fases: 1=Registro, 2=Validaci√≥n, 3=Clasificaci√≥n, 4=Transporte, 5=Entrega OK, 6=Entrega fallida, 7=Correcci√≥n/Alertas, 8=Resumen final
  - Almacena estad√≠sticas en localStorage y aplica una "morfog√©nesis" simple: la tasa de mala clasificaci√≥n disminuye tras aprender de fallos.
*/

/* --- Estado global --- */
let step = 1;
let paquete = {};
let lastProblem = ""; // texto descriptivo del √∫ltimo problema
const DEFAULT_MISCLASS_RATE = 0.20; // 20% probabilidad inicial de mala clasificaci√≥n
const MIN_MISCLASS_RATE = 0.05; // l√≠mite inferior
const LEARNING_FACTOR = 0.95; // cada fallo reduce la tasa multiplicando por este factor

/* Inicializar almacenamiento */
function loadOrInit() {
  if (!localStorage.getItem('misclassRate')) {
    localStorage.setItem('misclassRate', DEFAULT_MISCLASS_RATE.toString());
    localStorage.setItem('initialMisclassRate', DEFAULT_MISCLASS_RATE.toString());
  }
  if (!localStorage.getItem('envios_stats')) {
    const s = { total: 0, failures: 0, classFailures: 0, alerts: 0, feedbacks: 0 };
    localStorage.setItem('envios_stats', JSON.stringify(s));
  }
}
loadOrInit();

/* --- Helpers de stats --- */
function getMisclassRate() {
  return parseFloat(localStorage.getItem('misclassRate') || DEFAULT_MISCLASS_RATE);
}
function setMisclassRate(v) {
  localStorage.setItem('misclassRate', v.toString());
}
function getStats() {
  return JSON.parse(localStorage.getItem('envios_stats') || '{"total":0}');
}
function saveStats(s) {
  localStorage.setItem('envios_stats', JSON.stringify(s));
}
function incStat(key) {
  const s = getStats();
  s[key] = (s[key] || 0) + 1;
  saveStats(s);
}

/* --- Render de barra de progreso (colores por fase) --- */
const stepsMeta = [
  { id: 1, label: 'Registro', color: 'bg-blue-600' },
  { id: 2, label: 'Validaci√≥n', color: 'bg-emerald-600' },
  { id: 3, label: 'Clasificaci√≥n', color: 'bg-amber-500' },
  { id: 4, label: 'Transporte', color: 'bg-violet-600' },
  { id: 5, label: 'Entrega', color: 'bg-slate-500' },
];

function renderProgress() {
  const container = document.getElementById('progress');
  container.innerHTML = '';
  const row = document.createElement('div');
  row.className = 'flex gap-2 items-center';
  stepsMeta.forEach(s => {
    const isActive = step === s.id;
    const box = document.createElement('div');
    box.className = `flex-1 rounded-lg p-2 text-center text-xs font-medium ${isActive ? s.color : 'bg-slate-700/50'} ${isActive ? 'shadow-lg' : ''}`;
    box.textContent = s.label;
    row.appendChild(box);
  });
  container.appendChild(row);
}

/* --- Render principal (pantallas) --- */
function renderApp() {
  renderProgress();
  const app = document.getElementById('app');
  app.innerHTML = '';

  // Paso 1: Registro
  if (step === 1) {
    app.innerHTML = `
      <h2 class="text-lg font-semibold mb-3">Registro y recepci√≥n</h2>
      <div class="space-y-3">
        <input id="nombre" placeholder="Nombre remitente" class="w-full p-2 rounded-md bg-slate-900 border border-slate-700" />
        <input id="direccion" placeholder="Direcci√≥n destinatario" class="w-full p-2 rounded-md bg-slate-900 border border-slate-700" />
        <input id="telefono" placeholder="Tel√©fono" class="w-full p-2 rounded-md bg-slate-900 border border-slate-700" />
        <input id="peso" placeholder="Peso (kg)" class="w-full p-2 rounded-md bg-slate-900 border border-slate-700" />
        <input id="contenido" placeholder="Descripci√≥n del contenido (ej: Vasos de vidrio)" class="w-full p-2 rounded-md bg-slate-900 border border-slate-700" />
        <label class="block text-sm text-slate-300">¬øEs fr√°gil?</label>
        <select id="fragil" class="w-full p-2 rounded-md bg-slate-900 border border-slate-700">
          <option value="no">No</option>
          <option value="si">S√≠</option>
        </select>
        <div class="flex gap-2">
          <button onclick="guardarDatos()" class="flex-1 bg-blue-600 rounded-md py-2">Registrar paquete</button>
          <button onclick="resetAll()" class="flex-1 border border-slate-600 rounded-md py-2">Limpiar</button>
        </div>
        <p id="regError" class="text-xs text-red-400"></p>
      </div>
    `;
  }

  // Paso 2: Validaci√≥n
  if (step === 2) {
    app.innerHTML = `
      <h2 class="text-lg font-semibold mb-3">Validaci√≥n de datos</h2>
      <div class="bg-slate-900 rounded-lg p-4 border border-slate-700">
        <p><strong>Nombre:</strong> ${escapeHtml(paquete.nombre)}</p>
        <p><strong>Direcci√≥n:</strong> ${escapeHtml(paquete.direccion)}</p>
        <p><strong>Tel√©fono:</strong> ${escapeHtml(paquete.telefono)}</p>
        <p><strong>Peso:</strong> ${escapeHtml(paquete.peso)}</p>
        <p><strong>Contenido:</strong> ${escapeHtml(paquete.contenido)}</p>
        <p><strong>Etiqueta:</strong> <span class="${paquete.fragil === 'si' ? 'text-red-300' : 'text-emerald-300'}">${paquete.fragil === 'si' ? 'Fr√°gil üö®' : 'No fr√°gil ‚úÖ'}</span></p>
        <div class="mt-4 flex gap-2">
          <button onclick="nextStep(3)" class="flex-1 bg-emerald-600 py-2 rounded-md">Continuar (Validado)</button>
          <button onclick="nextStep(1)" class="flex-1 border border-slate-600 py-2 rounded-md">Corregir</button>
        </div>
      </div>
    `;
  }

  // Paso 3: Clasificaci√≥n (simulaci√≥n)
  if (step === 3) {
    const mis = Math.round(getMisclassRate()*100) + '%';
    app.innerHTML = `
      <h2 class="text-lg font-semibold mb-3">Fase de Clasificaci√≥n</h2>
      <div class="bg-amber-900/10 rounded-lg p-4 border border-amber-700">
        <p>Clasificaci√≥n autom√°tica en curso... <span class="text-xs text-slate-400">Tasa de fallo actual: ${mis}</span></p>
        <div class="mt-4 flex gap-2">
          <button onclick="runClassification(true)" class="flex-1 bg-amber-500 py-2 rounded-md">Simular clasificaci√≥n autom√°tica</button>
          <button onclick="forceClass('ok')" class="flex-1 bg-emerald-600 py-2 rounded-md">Forzar: correctamente clasificado</button>
          <button onclick="forceClass('bad')" class="flex-1 bg-red-600 py-2 rounded-md">Forzar: mal clasificado</button>
        </div>
        <p class="mt-3 text-sm text-slate-300">Si hay mal clasificaci√≥n aparece un punto entr√≥pico (ineficiencia) y se activa la correcci√≥n.</p>
      </div>
    `;
  }

  // Paso 4: Transporte (y simulaci√≥n de alertas)
  if (step === 4) {
    app.innerHTML = `
      <h2 class="text-lg font-semibold mb-3">Fase de Transporte</h2>
      <div class="bg-violet-900/10 rounded-lg p-4 border border-violet-700">
        <p>Estado: En tr√°nsito hacia destino.</p>
        <p class="text-sm text-slate-400 mt-2">Opciones de simulaci√≥n de punto de alerta (seg√∫n diagrama):</p>
        <div class="mt-3 flex gap-2">
          <button onclick="simulateAlert('retraso')" class="flex-1 bg-yellow-500 py-2 rounded-md">Simular retraso en clasificaci√≥n</button>
          <button onclick="simulateAlert('desvio')" class="flex-1 bg-red-600 py-2 rounded-md">Simular veh√≠culo desviado</button>
        </div>
        <div class="mt-3 flex gap-2">
          <button onclick="attemptDelivery()" class="flex-1 bg-emerald-600 py-2 rounded-md">Intentar entrega ahora</button>
          <button onclick="nextStep(5)" class="flex-1 border border-slate-600 py-2 rounded-md">Forzar entrega exitosa</button>
        </div>
        <p class="mt-3 text-xs text-slate-300">Puedes simular alertas y el sistema entrar√° en modo de correcci√≥n/homeostasis.</p>
      </div>
    `;
  }

  // Paso 5: Entrega exitosa
  if (step === 5) {
    incStat('total'); // registro del env√≠o completado (exitoso)
    app.innerHTML = `
      <h2 class="text-lg font-semibold mb-3">Entrega Exitosa ‚úÖ</h2>
      <div class="rounded-lg p-4 border ${paquete.fragil === 'si' ? 'border-red-500 bg-red-50/10' : 'border-emerald-500 bg-emerald-50/6'}">
        <p><strong>Gu√≠a:</strong> <span class="text-slate-200">#A${Math.floor(Math.random()*90000 + 10000)}</span></p>
        <p><strong>Contenido:</strong> ${escapeHtml(paquete.contenido)}</p>
        <p><strong>Etiqueta:</strong> <span class="${paquete.fragil === 'si' ? 'text-red-300' : 'text-emerald-300'}">${paquete.fragil === 'si' ? 'Fr√°gil üö®' : 'No fr√°gil ‚úÖ'}</span></p>
        <div class="mt-4 flex gap-2">
          <button onclick="nextStep(1)" class="flex-1 bg-blue-600 py-2 rounded-md">Registrar nuevo paquete</button>
          <button onclick="nextStep(4)" class="flex-1 border border-slate-600 py-2 rounded-md">Reenviar (simular)</button>
        </div>
      </div>
    `;
  }

  // Paso 6: Entrega fallida
  if (step === 6) {
    incStat('failures');
    app.innerHTML = `
      <h2 class="text-lg font-semibold mb-3 text-red-400">Entrega Fallida ‚ùå</h2>
      <div class="rounded-lg p-4 border border-red-600 bg-red-900/10">
        <p class="font-medium">Problema: ${escapeHtml(lastProblem)}</p>
        <p class="mt-2 text-sm">Opciones:</p>
        <div class="mt-3 flex gap-2">
          <button onclick="nextStep(7)" class="flex-1 bg-red-600 py-2 rounded-md">Abrir correcci√≥n / reprogramaci√≥n</button>
          <button onclick="nextStep(4)" class="flex-1 border border-slate-600 py-2 rounded-md">Reintentar transporte</button>
        </div>
      </div>
    `;
  }

  // Paso 7: Correcci√≥n / Homeostasis
  if (step === 7) {
    app.innerHTML = `
      <h2 class="text-lg font-semibold mb-3">Correcci√≥n del problema (Punto de Homeostasis)</h2>
      <div class="rounded-lg p-4 border border-slate-600 bg-slate-900/40">
        <p><strong>Problema detectado:</strong> ${escapeHtml(lastProblem)}</p>
        <p class="mt-2 text-sm text-slate-300">Acciones disponibles para corregir:</p>
        <div class="mt-3 grid grid-cols-1 gap-2">
          <button onclick="actionRetry()" class="w-full bg-emerald-600 py-2 rounded-md">Reintentar (intentar corregir autom√°ticamente)</button>
          <button onclick="actionReprogram()" class="w-full bg-blue-600 py-2 rounded-md">Reprogramar entrega</button>
          <button onclick="actionFeedback()" class="w-full border border-slate-600 py-2 rounded-md">Enviar retroalimentaci√≥n (mejora)</button>
          <button onclick="discardAndReturn()" class="w-full text-sm text-slate-400 underline">Descartar y volver al transporte</button>
        </div>
        <p class="mt-3 text-xs text-slate-400">Cada vez que se corrige o se recibe feedback, el sistema reduce ligeramente la tasa de error (morfog√©nesis).</p>
      </div>
    `;
  }

  // Paso 8 (Resumen/estad√≠sticas finales) - opcional
  if (step === 8) {
    app.innerHTML = `
      <h2 class="text-lg font-semibold mb-3">Resumen del sistema</h2>
      <div class="rounded-lg p-4 border border-slate-600 bg-slate-900/30">
        <div id="summaryContent"></div>
        <div class="mt-4 flex gap-2">
          <button onclick="nextStep(1)" class="flex-1 bg-blue-600 py-2 rounded-md">Nuevo env√≠o</button>
          <button onclick="resetStats()" class="flex-1 border border-slate-600 py-2 rounded-md">Reiniciar estad√≠sticas</button>
        </div>
      </div>
    `;
    document.getElementById('summaryContent').innerHTML = buildSummaryHtml();
  }

  // Actualizar panel de estad√≠sticas al final de render
  renderStats();
}

/* --- Funciones de acci√≥n --- */

// Escapa HTML para prevenir inyecci√≥n simple en el prototipo
function escapeHtml(str) {
  if (!str && str !== 0) return '';
  return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

function guardarDatos() {
  const n = document.getElementById('nombre').value.trim();
  const d = document.getElementById('direccion').value.trim();
  const t = document.getElementById('telefono').value.trim();
  const p = document.getElementById('peso').value.trim();
  const c = document.getElementById('contenido').value.trim();
  const f = document.getElementById('fragil').value;

  const errEl = document.getElementById('regError');
  errEl.textContent = '';

  // Validaciones b√°sicas
  if (!n || !d || !t) {
    errEl.textContent = 'Por favor completa: nombre, direcci√≥n y tel√©fono.';
    return;
  }

  paquete = { nombre: n, direccion: d, telefono: t, peso: p || '‚Äî', contenido: c || 'Sin descripci√≥n', fragil: f };
  nextStep(2);
}

// Simulaci√≥n de clasificaci√≥n
function runClassification(auto = true) {
  // Si auto=true, usa probabilidad; sino usa forzado por forceClass
  const rate = getMisclassRate();
  const rnd = Math.random();
  const misclassified = rnd < rate;

  if (misclassified) {
    // registro de fallo de clasificaci√≥n
    incStat('classFailures');
    incStat('alerts'); // lo consideramos un alerta relevante
    lastProblem = 'Paquete mal clasificado (punto entr√≥pico: aumenta la ineficiencia)';
    // aprendizaje: bajar la tasa de misclass
    const newRate = Math.max(MIN_MISCLASS_RATE, rate * LEARNING_FACTOR);
    setMisclassRate(newRate);
    nextStep(7);
  } else {
    nextStep(4); // continuar a transporte (agrupaci√≥n/transport)
  }
}

function forceClass(mode) {
  if (mode === 'ok') {
    nextStep(4);
  } else {
    incStat('classFailures');
    incStat('alerts');
    lastProblem = 'Paquete mal clasificado (forzado)';
    // aplicar peque√±o aprendizaje
    const rate = getMisclassRate();
    setMisclassRate(Math.max(MIN_MISCLASS_RATE, rate * LEARNING_FACTOR));
    nextStep(7);
  }
}

// Simular alertas en transporte
function simulateAlert(type) {
  incStat('alerts');
  if (type === 'retraso') {
    lastProblem = 'Retraso en clasificaci√≥n (impacta tiempos de entrega)';
  } else if (type === 'desvio') {
    lastProblem = 'Veh√≠culo desviado (posible perdida de ruta)';
  } else {
    lastProblem = 'Alerta desconocida';
  }
  nextStep(7);
}

// Intento de entrega con probabilidad de fallo
function attemptDelivery() {
  // Definimos una tasa baja de fallo de entrega
  const DELIV_FAIL_RATE = 0.10; // 10% por defecto
  const rnd = Math.random();
  if (rnd < DELIV_FAIL_RATE) {
    lastProblem = 'Entrega fallida (receptor no disponible / problemas log√≠sticos)';
    incStat('failures');
    nextStep(6);
  } else {
    nextStep(5);
  }
}

/* --- Acciones de correcci√≥n / homeostasis --- */
function actionRetry() {
  // Si el problema fue de clasificaci√≥n, reintentar clasificaci√≥n:
  if (lastProblem.toLowerCase().includes('clasific')) {
    // reintentar clasificaci√≥n (menos probabilidad por morfog√©nesis)
    runClassification();
  } else if (lastProblem.toLowerCase().includes('desvi') || lastProblem.toLowerCase().includes('retras')) {
    // simulamos soluci√≥n y volvemos a transporte
    nextStep(4);
  } else if (lastProblem.toLowerCase().includes('entrega')) {
    // reintentar entrega con otra probabilidad
    attemptDelivery();
  } else {
    nextStep(4);
  }
}

function actionReprogram() {
  // reprograma: volvemos al transporte pero marcamos como reprogramado y registro
  lastProblem = 'Reprogramaci√≥n solicitada';
  nextStep(4);
}

function actionFeedback() {
  // retroalimentaci√≥n del usuario, se guarda y mejora el sistema
  incStat('feedbacks');
  const rate = getMisclassRate();
  setMisclassRate(Math.max(MIN_MISCLASS_RATE, rate * 0.90)); // feedback reduce tasa m√°s agresivamente
  nextStep(4);
}

function discardAndReturn() {
  nextStep(4);
}

/* --- Utilidades y navegaci√≥n --- */
function nextStep(n) {
  step = n;
  // Si llegamos a paso 5 (entrega exitosa) contamos como env√≠o total:
  if (step === 5) {
    const s = getStats();
    s.total = (s.total || 0) + 1;
    saveStats(s);
  }
  renderApp();
}

function resetAll() {
  paquete = {};
  lastProblem = '';
  step = 1;
  renderApp();
}

function resetStats() {
  const s = { total: 0, failures: 0, classFailures: 0, alerts: 0, feedbacks: 0 };
  saveStats(s);
  localStorage.setItem('misclassRate', DEFAULT_MISCLASS_RATE.toString());
  localStorage.setItem('initialMisclassRate', DEFAULT_MISCLASS_RATE.toString());
  renderApp();
}

/* --- Forzar clasificaci√≥n externa (botones) --- */
function attemptDeliverySuccessForDemo() {
  nextStep(5);
}

/* --- Resumen y estad√≠sticas (panel lateral) --- */
function renderStats() {
  const el = document.getElementById('stats');
  const s = getStats();
  const misNow = getMisclassRate();
  const initMis = parseFloat(localStorage.getItem('initialMisclassRate') || DEFAULT_MISCLASS_RATE);
  const improvement = Math.max(0, (initMis - misNow) / initMis * 100);
  el.innerHTML = `
    <div class="grid grid-cols-2 gap-2">
      <div class="text-xs">Env√≠os totales</div><div class="text-right font-medium">${s.total}</div>
      <div class="text-xs">Fallos totales</div><div class="text-right font-medium">${s.failures}</div>
      <div class="text-xs">Fallos clasificaci√≥n</div><div class="text-right font-medium">${s.classFailures}</div>
      <div class="text-xs">Alertas</div><div class="text-right font-medium">${s.alerts}</div>
      <div class="text-xs">Feedbacks</div><div class="text-right font-medium">${s.feedbacks}</div>
      <div class="text-xs">Tasa mal clasificaci√≥n</div><div class="text-right font-medium">${Math.round(misNow*100)}%</div>
    </div>
  `;
  const morpho = document.getElementById('morphoMsg');
  morpho.innerHTML = `Morfog√©nesis: la tasa inicial de mala clasificaci√≥n era ${Math.round(initMis*100)}%, ahora ${Math.round(misNow*100)}% (${Math.round(improvement)}% de mejora acumulada).`;
}

/* --- Build summary HTML para paso 8 --- */
function buildSummaryHtml() {
  const s = getStats();
  const misNow = getMisclassRate();
  return `
    <p><strong>Total env√≠os:</strong> ${s.total}</p>
    <p><strong>Fallos totales:</strong> ${s.failures}</p>
    <p><strong>Fallos por clasificaci√≥n:</strong> ${s.classFailures}</p>
    <p><strong>Alertas registradas:</strong> ${s.alerts}</p>
    <p class="mt-2"><strong>Tasa actual de mala clasificaci√≥n:</strong> ${Math.round(misNow*100)}%</p>
    <p class="mt-3 text-sm text-slate-300">Este resumen refleja la retroalimentaci√≥n (morfog√©nesis) acumulada: tras fallos y feedbacks, el sistema reduce la tasa de errores y se adapta.</p>
  `;
}

/* --- Inicial render --- */
renderApp();

</script>
</body>
</html>

